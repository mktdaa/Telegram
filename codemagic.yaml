workflows:
  build-telegram:
    name: Build Telegram Android
    max_build_duration: 60
    environment:
      vars:
        RELEASE_STORE_FILE: TMessagesProj/config/release.keystore
        RELEASE_KEY_ALIAS: telegram
        RELEASE_STORE_PASSWORD: telegram123
        RELEASE_KEY_PASSWORD: telegram123
    scripts:
      - name: إعداد Android SDK
        script: |
          sdkmanager "platforms;android-31" "build-tools;31.0.0" "ndk;21.4.7075529"
      - name: تحديث مكتبات C/C++
        script: |
          git submodule update --init --recursive
      - name: إنشاء ملف google-services.json
        script: |
          echo '{}' > TMessagesProj/google-services.json
      - name: إنشاء ملف keystore وهمي للتجربة
        script: |
          mkdir -p TMessagesProj/config
          keytool -genkey -v -keystore $RELEASE_STORE_FILE -storepass $RELEASE_STORE_PASSWORD -alias $RELEASE_KEY_ALIAS -keypass $RELEASE_KEY_PASSWORD -dname "CN=Telegram,O=Org,C=US" -keyalg RSA -keysize 2048 -validity 10000
      - name: بناء APK
        script: |
          ./gradlew :TMessagesProj:assemblePlayRelease \
            -Pandroid.injected.signing.store.file=$RELEASE_STORE_FILE \
            -Pandroid.injected.signing.store.password=$RELEASE_STORE_PASSWORD \
            -Pandroid.injected.signing.key.alias=$RELEASE_KEY_ALIAS \
            -Pandroid.injected.signing.key.password=$RELEASE_KEY_PASSWORD
    artifacts:
      - TMessagesProj/build/outputs/**/*.apk
